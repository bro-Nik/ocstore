{% extends 'revolution/template/product/partials/base.twig' %}

{% macro category_option(category, selected_id, level) %}
  <option value="{{ category.category_id }}" {% if category.category_id == selected_id %}selected{% endif %}>
    {% for i in 1..level %}&nbsp;&nbsp;{% endfor %}{{ category.name }}
  </option>
    
  {% if category.children %}
    {% for child in category.children %}
      {{ _self.category_option(child, selected_id, level + 1) }}
    {% endfor %}
  {% endif %}
{% endmacro %}

{% block container_schema %}{% endblock %}

{% block content %}
  <div class="search-container">
    <form class="search-form">
      <div class="search-fields">
        <div class="form-group">
          <input type="text" name="search" id="input-search" class="form-control" placeholder="{{ text_keyword }}" value="{{ search }}">
        </div>
        
        <div class="form-group">
          <select name="category_id" id="category-select" class="form-control">
            <option value="0">{{ text_category }}</option>
            {% for category in categories %}
              {{ _self.category_option(category, category_id, 0) }}
            {% endfor %}
          </select>
        </div>
        
        <button type="submit" class="btn btn-primary">{{ button_search }}</button>
      </div>
      
      <div class="search-options">
        {% if not ajax_search_description %}
        <div class="form-check form-check-inline">
          <input type="checkbox" name="description" id="description" class="form-check-input" value="1" {{ description ? 'checked' }}>
          <label for="description" class="form-check-label">{{ entry_description }}</label>
        </div>
        {% endif %}
        
        <div class="form-check form-check-inline">
          <input type="checkbox" name="sub_category" id="sub-category" class="form-check-input" value="1" {{ sub_category ? 'checked' }}>
          <label for="sub-category" class="form-check-label">{{ text_sub_category }}</label>
        </div>
      </div>
    </form>
    
    <h2 class="search-results-title">{{ text_search }}</h2>
    
    {% include 'revolution/template/product/partials/products.twig' %}
    
    {{ content_bottom }}
  </div>
{% endblock %}

{% block script %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Elements
  const searchButton = document.getElementById('button-search');
  const searchInput = document.querySelector('#content input[name="search"]');
  const categorySelect = document.querySelector('select[name="category_id"]');
  const subCategoryCheckbox = document.querySelector('input[name="sub_category"]');

  // Handle search
  function performSearch() {
    const params = new URLSearchParams();
    
    if (searchInput?.value) {
      params.append('search', searchInput.value);
    }
    
    if (categorySelect?.value > 0) {
      params.append('category_id', categorySelect.value);
    }
    
    if (document.querySelector('#content input[name="sub_category"]:checked')) {
      params.append('sub_category', 'true');
    }
    
    if (document.querySelector('#content input[name="description"]:checked')) {
      params.append('description', 'true');
    }
    
    window.location.href = `index.php?route=product/search&${params.toString()}`;
  }

  // Event listeners
  if (searchButton) {
    searchButton.addEventListener('click', performSearch);
  }
  
  if (searchInput) {
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') performSearch();
    });
  }
  
  if (categorySelect && subCategoryCheckbox) {
    categorySelect.addEventListener('change', function() {
      subCategoryCheckbox.disabled = this.value === '0';
    });
    
    // Initialize on load
    categorySelect.dispatchEvent(new Event('change'));
  }
});
</script>
{% endblock %}
